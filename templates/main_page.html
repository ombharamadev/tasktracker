<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/Alkalami.css">
    <link rel="stylesheet" href="assets/css/Navbar-Centered-Brand-Dark-icons.css">
    <link rel="stylesheet" href="assets/css/Sidebar-Menu-sidebar.css">
    <link rel="stylesheet" href="assets/css/Sidebar-Menu.css">
    <link rel="stylesheet" href="assets/css/SIdebar-Responsive-2-ResponsiveSideBar-2.css">
    <link rel="stylesheet" href="assets/css/SIdebar-Responsive-2.css">
    <link rel="stylesheet" href="assets/css/sidebar-style4.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
</head>

<body onload="show1()">
    <nav class="navbar navbar-expand-md bg-dark py-3" data-bs-theme="dark">
        <div class="container"><a class="navbar-brand d-flex align-items-center" href="#"><span class="bs-icon-sm bs-icon-rounded bs-icon-primary d-flex justify-content-center align-items-center me-2 bs-icon"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-list-task">
                        <path fill-rule="evenodd" d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5zM3 3H2v1h1z"></path>
                        <path d="M5 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5M5.5 7a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1zm0 4a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1z"></path>
                        <path fill-rule="evenodd" d="M1.5 7a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5zM2 7h1v1H2zm0 3.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm1 .5H2v1h1z"></path>
                    </svg></span><span style="font-size: 27px;">TaskTracker</span></a><button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navcol-6"><span class="visually-hidden">Toggle navigation</span></button>
            <div class="collapse navbar-collapse flex-grow-0 order-md-first" id="navcol-6">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"></li>
                    <li class="nav-item"></li>
                </ul>
                <div class="d-md-none my-2"><button class="btn btn-light me-2" type="button">Button</button><button class="btn btn-primary" type="button">Button</button></div>
            </div>
            <div class="d-none d-md-block"></div>
        </div>
    </nav>

    <script>
        function show1(){
            checkToken();
            //document.getElementById("viewchart").style.display = '';
            document.getElementById("viewchart").style.display = ''
            document.getElementById("viewlist").style.display = 'none'
            document.getElementById("addtaskview").style.display = 'none'
           
        }
        function show2(){
            //document.getElementById("viewchart").style.display = '';
            document.getElementById("viewchart").style.display = 'none'
            document.getElementById("viewlist").style.display = ''
            document.getElementById("addtaskview").style.display = 'none'
           
        }
        function show3(){
            //document.getElementById("viewchart").style.display = '';
            document.getElementById("viewchart").style.display = 'none'
            document.getElementById("viewlist").style.display = 'none'
            document.getElementById("addtaskview").style.display = ''
           
        }
    </script>
    <div class="container">
        <div class="row">
            <div class="col-md-4"><button onclick="show1()" class="btn btn-primary" type="button" style="background: rgba(66,0,255,0.98);border-style: none;">View Task Chart</button></div>
            <div class="col-md-4"><button onclick="show2()" class="btn btn-primary" type="button" style="background: rgb(253,13,200);border-style: none;">View Task List</button></div>
            <div class="col-md-4"><button onclick="show3()" class="btn btn-primary" type="button">Add Task</button></div>
        </div>
    </div>
    <section id="viewchart" style="margin-top: 75px;">
        <h1 style="text-align: center;">View Task Chart</h1>
        <div style="margin-top: 25px;">
            <div class="container">
                <div class="row">
                    <div class="col-md-4" style="border-style: solid;border-color: rgb(19,122,225);">
                        <h1>Todo</h1>
                        <ul id="todolist">
                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    fetch('api/gettodolist?format=json')
                                        .then(response => response.json())
                                        .then(data => {
                                            const todoList = document.getElementById('todolist');
                                            data.forEach(item => {
                                                const listItem = document.createElement('li');
                                                listItem.textContent = `${item.title}: ${item.desc}`;
                                                todoList.appendChild(listItem);
                                            });
                                        })
                                        .catch(error => console.error('Error fetching data:', error));
                                });
                            </script>
                        </ul>


                    </div>
                    <div class="col-md-4" style="border-style: solid;border-color: rgb(19,122,225);">
                        <h1>Inprogress</h1>
                        <ul id="inprogress">
                           
                        </ul>
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                fetch('api/getinproglist?format=json')
                                    .then(response => response.json())
                                    .then(data => {
                                        const todoList = document.getElementById('inprogress');
                                        data.forEach(item => {
                                            const listItem = document.createElement('li');
                                            listItem.textContent = `${item.title}: ${item.desc}`;
                                            todoList.appendChild(listItem);
                                        });
                                    })
                                    .catch(error => console.error('Error fetching data:', error));
                            });
                        </script>


                    </div>
                    <div class="col-md-4" style="border-style: solid;border-color: rgb(19,122,225);">
                        <h1>Done</h1>
                        <ul id="done">
                            
                        </ul>


                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                fetch('api/getdonelist?format=json')
                                    .then(response => response.json())
                                    .then(data => {
                                        const todoList = document.getElementById('done');
                                        data.forEach(item => {
                                            const listItem = document.createElement('li');
                                            listItem.textContent = `${item.title}: ${item.desc}`;
                                            todoList.appendChild(listItem);
                                        });
                                    })
                                    .catch(error => console.error('Error fetching data:', error));
                            });
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section id="viewlist" style="margin-top: 55px;">
        <h1 style="text-align: center;">View Task List</h1>
        <div class="table-responsive">
            <table id="tabledata" class="table">
                <thead>
                    <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Due Date</th>
                    
                    <th>Assign Email</th>
                    <th>Task Status</th>
                    <th>Update Operation</th>
                    <th>Delete Operation</th>
                    
                    </tr>
                </thead>
                
                <tbody id="tablebody"></tbody>
            </table>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    fetch('/api/gettasklist?format=json')
                        .then(response => response.json())
                        .then(data => {
                            const tableBody = document.getElementById('tablebody');
                            let n = 0
                            data.forEach(task => {
                                const row = document.createElement('tr');
                                n = n +1;
                                row.innerHTML = `
                                    <td>`+n+`</td>
                                    <td>${task.title}</td>
                                    <td>${task.desc}</td>
                                    <td>${task.due_date}</td>
                                    
                                    <td id="assignEmail_${task.task_id}">Fetching...</td>
                                    <td>${task.task_status}</td>
                                    <td><a style="color:blue" href="/update/${task.task_id}">Update</a></td>
                                    <td><a style="color:red" href="/delete/${task.task_id}">Delete</a></td>
                                    
                                `;
                                tableBody.appendChild(row);
        
                                // Fetch assign emails for this task_id
                                fetch(`/api/getassignlist?format=json&task_id=${task.task_id}`)
                                    .then(response => response.json())
                                    .then(assignData => {
                                        const assignEmailCell = document.getElementById(`assignEmail_${task.task_id}`);
                                        if (assignData.length > 0) {
                                            const emails = assignData.map(assign => assign.assign_email).join(', ');
                                            assignEmailCell.textContent = emails;
                                        } else {
                                            assignEmailCell.textContent = 'No assign emails found';
                                        }
                                    })
                                    .catch(error => console.error('Error fetching assign emails:', error));
                            });
                        })
                        .catch(error => console.error('Error fetching task list:', error));
                });
            </script>


        </div>
    </section>
    <section id="addtaskview">
        <h1 style="text-align: center;">Add Task</h1>
        <div>
            
            <div class="container">
                <div class="row" style="margin-top: 22px;">
                    <div class="col-md-6" style="text-align: center;"><label class="col-form-label" style="font-size: 26px;font-family: Alkalami, serif;">Title</label></div>
                    <div class="col-md-6"><input type="text"  id="title" name= "title" style="width: 100%;height: 100%;"></div>
                </div>
                <div class="row" style="margin-top: 22px;">
                    <div class="col-md-6" style="text-align: center;"><label class="col-form-label" style="font-size: 26px;">Description</label></div>
                    <div class="col-md-6" style="height: 151px;"> <input id="desc" type="text" name="desc" style="width: 100%;height: 100%;"></input></div>
                </div>
                <div class="row" style="margin-top: 25px;">
                    <div class="col-md-6" style="text-align: center;"><label class="col-form-label" style="font-size: 26px;">Assign To</label></div>
                    <div class="col-md-6"><select multiple="" id="assignto" name="assignto" style="width: 100%;min-width: 100%;">
                            
                        </select></div>
                </div>
                <div class="row" style="margin-top: 25px;">
                    <div class="col-md-6" style="text-align: center;"><label class="col-form-label" style="font-size: 26px;">Due Date</label></div>
                    <div class="col-md-6"><input id="duedate" name="duedate" type="date" style="width: 100%;min-width: 100%;"></div>
                </div>
                <div class="row" style="margin-top: 25px;">
                    <div class="col-md-6" style="text-align: center;"><label class="col-form-label" style="font-size: 26px;">Status</label></div>
                    <div class="col-md-6"><select id="taskstatus" name="taskstatus" style="width: 100%;height: 100%;">
                            <option value="todo" selected="">Todo</option>
                            <option value="inprogress">InProgress</option>
                            <option value="done">Done</option>
                        </select></div>
                </div>
                <div class="row" style="margin-top: 25px;">
                    <div class="col-md-6" style="text-align: center;"><label class="col-form-label" style="font-size: 26px;"></label></div>
                    <div class="col-md-6"><button class="btn btn-primary" onclick="addtask()" type="submit" style="width: 100%;height: 100%;">Save</button></div>
                </div>
            </div>
            
        </div>
    </section>
    <footer class="text-center bg-dark" style="margin-top: 84px;">
        <div class="container text-white py-4 py-lg-5"><img class="rounded-circle" src="assets/img/jaswalaryan.jpg" style="min-width: 100px;max-width: 150px;">
            <h4>Made By Jaswal Aryan</h4>
            <p>jaswalaryan@proton.me</p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/Sidebar-Menu-sidebar.js"></script>



<script>
    function addtask(){

        let title = document.getElementById("title").value
        let desc = document.getElementById("desc").value;
        let duedate = document.getElementById("duedate").value;
        let taskstatus = document.getElementById("taskstatus").value;

        const url = 'api/addtask';
        const data = {
            'title':title,
            'desc': desc,
            'due_date': duedate,
            'task_status':taskstatus
        };

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
    if (data.status === 'Success') {
        assignto(data.task_id);
        alert("Task Added..")
        document.location.href = "/dashboard"
    } else {
        alert(data.status);
    }
    
    })
        .catch(error => console.error('Error:', error));


    }

    function assignto(task_id){
        let a = document.getElementById("assignto");
        let lena = a.selectedOptions.length;
        for(let i=0; i<lena ; i++){
            assing_to = a.selectedOptions[i].value;
            
            const url = 'api/assignto';
            const data = {
                'task_id' : task_id,
                'assign_email' : assing_to
            };

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            
            .catch(error => console.error('Error:', error));

        }
    }
</script>






<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/getemaillist?format=json')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('assignto');
                data.forEach(email => {
                    const option = document.createElement('option');
                    option.value = email;
                    option.textContent = email;
                    select.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching email list:', error));
    });
</script>
<script>
    // Check if the token is present in the cookie
function checkToken() {
    var token = getCookie('token');
    if (!token) {
        // Token not found, redirect to /login
        window.location.href = '/';
    }
}

// Function to get cookie value by name
function getCookie(name) {
    var cookies = document.cookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
            return cookie.substring(name.length + 1);
        }
    }
    return null;
}

// Call the checkToken function when the page loads


</script>
</body>

</html>